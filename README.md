# Price Rollout System

## Objective
The objective of this system is to seamlessly rollout price changes for the users in different countries and on various plans.

### Scope
The scope of the project is the rollout of price changes and get the rollout status in a concurrent system.

### Design Overview
#### Technologies Used
We are using Mysql datastore for persisting data. The Application is a rest service in Java with Spring framework.

### Design
We have 3 endpoints in the initial version(v1). 
#### Create Rollout
The users will use the rollout(POST) api to create rollout and will be given a rollout id to determine the staus.

Everytime a rollout is created a rollout id is returned and rollout status is marked as "NEW". Rollout id is the id generated by database while persisting.
A thread is invoked to process the rollout. The thread does the following:
1. Create a lock on the countryid, planid being updated. If cannot create a lock, it sleeps for 1s and retries 3 times. Even if it is not successful, it marks the rollout as failure.
2. If lock is created successfully, it updates the rollout status as "PROCESSING".
3. updates the users with request country and plan with the status.
4. updates the rollout status as "DONE".
5. Deletes the lock on the countryid and planid being updated.

#### Get Rollout Status
This endpoint will return rollout status of the given rollout id. The upstream service can check the status of the rollout using this API.

#### Get User information
This endpoint will return the user information with user id, country id, plan id and price. This endpoint will be particularly useful when there is issue that price change is not reflected on a user's account.

### Database Design
There are 4 tables. 
1. USER_PLAN: To store the user id, country id, plan id and price.
2. LOCK_UPDATE_BY_COUNTRY_ID: This table ensures that no two requests executes update on a particular countryid and plan id.
3. ROLLOUT_STATUS: To store the status of the rollout.
4. PRICE_REVISION: To store the history of the rollout including old price and new price with the rollout id.

### Scalability
The system is designed to use concurrent threads to execute the rollouts. 
We can horizontally scale this application with multiple servers and balance load using load balancer.

### What is not done?
Junits are not done.
The system is designed simple. There can be additions on User information in a different database with email id. Create another endpoint to rollback to the old price.
We are not preventing if the request tries to update to the original price.
Error handling is not done completely. Inserted lock records on lock table is not removed in case of error.

### How to Run
1. create table scripts are available at https://github.com/kavithol/PriceRollout/blob/master/src/main/resources/createTable.sql
2. Run this test to create data https://github.com/kavithol/PriceRollout/blob/master/src/test/java/com/netflix/price/hibernate/factory/HibernateUtilTest.java#L40
2. Project war is located at https://github.com/kavithol/PriceRollout/blob/master/src/main/resources/pricerollout-1.0-SNAPSHOT.war
2. For api request to build from swagger, https://github.com/kavithol/PriceRollout/blob/master/src/main/resources/swagger.json
